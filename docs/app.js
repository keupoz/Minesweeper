!function(){"use strict";function t(t){var e=t.clientX,i=t.clientY;return{x:e-=this.target.offsetLeft,y:i-=this.target.offsetTop}}function s(){var t=document.createElement("canvas").getContext("2d");return t.imageSmoothingEnabled=!1,t}EventTarget.prototype.on=function(t,i){for(var s=this,n=[],e=arguments.length-2;0<e--;)n[e]=arguments[e+2];t.split(" ").forEach(function(t){var e;(e=s).addEventListener.apply(e,[t,i].concat(n))})},EventTarget.prototype.off=function(t,i){for(var s=this,n=[],e=arguments.length-2;0<e--;)n[e]=arguments[e+2];t.split(" ").forEach(function(t){var e;(e=s).removeEventListener.apply(e,[t,i].concat(n))})},MouseEvent.prototype.getPoint=function(){return t.call(this,this)},"TouchEvent"in window&&(TouchEvent.prototype.getPoint=function(){return t.call(this,this.changedTouches[0])});var r=function(t,e){this.x=t,this.y=e,this.hasMine=this.marked=this.revealed=!1,this.minesAround=0};r.prototype.placeMine=function(){this.hasMine=!0},r.prototype.mark=function(t){return!this.revealed&&(this.marked=t||!this.marked,!0)},r.prototype.reveal=function(){return!this.revealed&&!this.marked&&(this.revealed=!0)};var h=function(){for(var t,e=[],i=arguments.length;i--;)e[i]=arguments[i];this.changed=new Array,(t=this).init.apply(t,e)},e={finished:{configurable:!0}};e.finished.get=function(){return this.won||this.failed},h.prototype.resetChanges=function(){this.changed.length=0},h.prototype.reset=function(){this.started=this.won=this.failed=!1,this.minesTotal=this.minesLeft=this.minesPercentage*this.tiles.length,this.resetChanges()},h.prototype.reinit=function(){this.init(this.width,this.height,this.minesPercentage)},h.prototype.init=function(t,e,i){this.width=t,this.height=e,this.minesPercentage=i,this.field=new Array(this.width),this.tiles=new Array(this.width*this.height),this.reset();for(var s=0,n=0;n<this.width;n++){this.field[n]=new Array(this.height);for(var h=0;h<this.height;h++)this.field[n][h]=this.tiles[s++]=this.changed[s++]=new r(n,h)}},h.prototype.start=function(t,e){this.placeMines(t,e),this.reveal(t,e),this.started=!0},h.prototype.getTile=function(t,e,i){this.field[t]&&this.field[t][e]&&i.call(this,this.field[t][e])},h.prototype.getNeighbours=function(t,e){for(var i=t.x,s=t.y,n=-1;n<=1;n++)for(var h=-1;h<=1;h++)0===n&&0===h||this.getTile(i+n,s+h,e)},h.prototype.placeMines=function(e,i){for(var t,s=this,n=this.tiles.filter(function(t){return t.x!==e&&t.y!==i}),h=0;h<this.minesTotal;h++){var r=(t=n.length,Math.floor(Math.random()*t));n[r].placeMine(),n.splice(r,1)}this.tiles.forEach(function(e){e.hasMine||s.getNeighbours(e,function(t){t.hasMine&&e.minesAround++})})},h.prototype.revealNeighbours=function(t){var e=this,i=[],s=0;this.getNeighbours(t,function(t){t.marked?s++:t.revealed||i.push(t)}),i.length&&(!t.minesAround||s&&s>=t.minesAround)&&i.forEach(function(t){return e.revealTile(t)})},h.prototype.revealTile=function(t,e){t.reveal()&&(this.changed.push(t),t.hasMine&&(this.failed=!0)),this.failed||t.minesAround&&!e||this.revealNeighbours(t)},h.prototype.reveal=function(t,e){this.getTile(t,e,function(t){t.marked||(this.revealTile(t,t.revealed),this.checkWin())})},h.prototype.markTile=function(t){t.mark()&&(this.minesLeft+=t.marked?-1:1,this.changed.push(t))},h.prototype.markNeighbours=function(t){var e=this,i=[],s=0;this.getNeighbours(t,function(t){t.revealed||(t.marked||i.push(t),s++)}),i.length&&t.minesAround>=s&&i.forEach(function(t){return e.markTile(t)})},h.prototype.mark=function(t,e){this.getTile(t,e,function(t){t.revealed?this.markNeighbours(t):this.markTile(t)}),this.checkWin()},h.prototype.checkWin=function(){var e=this;if(!this.won&&!this.failed&&this.changed.length){var i=[],s=[],n=0;this.tiles.forEach(function(t){t.revealed||(i.push(t),t.marked?t.hasMine&&n++:s.push(t))}),i.length===this.minesTotal?(i.forEach(function(t){return t.mark(!0)}),this.minesLeft=0,this.won=!0):n===this.minesTotal&&(s.forEach(function(t){return e.revealTile(t)}),this.won=!0)}},Object.defineProperties(h.prototype,e);var i=function(){this.ctx=s(),this.domElement=this.ctx.canvas;var t=this.domElement,e=t.width,i=t.height;this.setSize(e,i)};i.prototype.setSize=function(t,e){this.domElement.width=this.width=t,this.domElement.height=this.height=e},i.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)},i.prototype.fill=function(t){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height)},i.prototype.update=function(){},i.prototype.render=function(){};var n=[-1,"royalblue","forestgreen","tomato","darkblue","maroon","darkcyan","purple","cyan"],o=function(t){this.tileSize=t,this.tileHalf=this.tileSize/2,this.init()};o.prototype.getRevealed=function(t){return!0===t&&(t=-1),this["revealed"+t]},o.prototype.prepair=function(){var t=s();return t.canvas.width=t.canvas.height=this.tileSize,t},o.prototype.initRevealed=function(t){var e=this.prepair();if(this["revealed"+t]=e.canvas,e.fillStyle="whitesmoke",e.fillRect(0,0,this.tileSize,this.tileSize),-1===t){var i=this.tileSize/3;e.beginPath(),e.fillStyle="#333333",e.arc(this.tileHalf,this.tileHalf,i,0,2*Math.PI),e.fill(),e.closePath()}else t&&(e.fillStyle=n[t],e.font="bold "+this.tileHalf+"px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText(t,this.tileHalf,this.tileHalf))},o.prototype.initUnrevealed=function(){var t=this.prepair();this.unrevealed=t.canvas,t.fillStyle="dodgerblue",t.fillRect(0,0,this.tileSize,this.tileSize)},o.prototype.initMarked=function(){var t=this.prepair(),e=this.tileSize/3;this.marked=t.canvas,t.drawImage(this.unrevealed,0,0),t.beginPath(),t.fillStyle="#eeeeee",t.arc(this.tileHalf,this.tileHalf,e,0,2*Math.PI),t.fill(),t.closePath()},o.prototype.init=function(){for(var t=-1;t<9;t++)this.initRevealed(t);this.initUnrevealed(),this.initMarked()};var a=function(s){function t(t,e,i){s.call(this),this.map=t,this.tileSize=e,this.margin=i,this.tileArea=this.tileSize+this.margin,this.assets=new o(this.tileSize),this.changed=!1}return s&&(t.__proto__=s),((t.prototype=Object.create(s&&s.prototype)).constructor=t).prototype.update=function(){var t=this.tileArea*this.map.width-this.margin,e=this.tileArea*this.map.height-this.margin;this.width===t&&this.height===e||(this.setSize(t,e),this.changed=!0)},t.prototype.render=function(){var n=this;if(this.changed&&this.map.changed.length){var t=this.changed?this.map.tiles:this.map.changed;this.changed&&this.fill("#dddddd"),t.length&&t.forEach(function(t){var e,i=t.x*n.tileArea,s=t.y*n.tileArea;e=t.revealed?n.assets.getRevealed(t.hasMine||t.minesAround):t.marked?n.assets.marked:n.assets.unrevealed,n.ctx.drawImage(e,i,s)}),this.map.resetChanges()}},t}(i),c=function(e){function t(t){e.call(this),this.mapRenderer=t,this.mapX=this.mapY=0,this.offsetX=this.offsetY=0,this.scale=.5}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.setOffset=function(t,e){this.offsetX=t,this.offsetY=e},t.prototype.move=function(t,e){this.setOffset(this.offsetX+t/this.scale,this.offsetY+e/this.scale)},t.prototype.zoom=function(t){this.scale+=t,this.scale<.25?this.scale=.25:2<this.scale&&(this.scale=2)},t.prototype.updateCenter=function(){this.centerX=this.width/2,this.centerY=this.height/2},t.prototype.updateMapPosition=function(){this.mapX=this.offsetX-this.mapRenderer.width/2,this.mapY=this.offsetY-this.mapRenderer.height/2},t.prototype.update=function(t){var e=t.width,i=t.height;this.width===e&&this.height===i||(this.setSize(e,i),this.updateCenter()),this.mapRenderer.update(),this.updateMapPosition()},t.prototype.render=function(){this.mapRenderer.changed&&(this.mapRenderer.render(),this.ctx.setTransform(1,0,0,1,0,0),this.clear(),this.ctx.translate(this.centerX,this.centerY),this.ctx.scale(this.scale,this.scale),this.ctx.translate(this.mapX,this.mapY),this.ctx.drawImage(this.mapRenderer.domElement,0,0))},t}(i),l=function(e){function t(t){e.call(this),this.map=t}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.update=function(t){var e=t.width,i=t.height;this.width===e&&this.height===i||this.setSize(e,i)},t.prototype.render=function(){this.clear(),this.ctx.fillStyle="#333333",this.ctx.fillRect(0,0,40,40),this.ctx.fillStyle="whitesmoke",this.ctx.font="bold 20px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(this.map.minesLeft,20,20),this.map.finished&&(this.ctx.fillStyle=this.map.won?"limegreen":"maroon",this.ctx.font="bold "+(this.map.failed?"italic":"")+" 70px monospace",this.ctx.fillText(this.map.won?"You won!":"YOU DIED",this.width/2,this.height/2))},t}(i),p=function(t){function e(){t.call(this),this.screens=new Array}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.add=function(){for(var t,e=[],i=arguments.length;i--;)e[i]=arguments[i];(t=this.screens).push.apply(t,e)},e.prototype.update=function(){var e=this;this.screens.forEach(function(t){return t.update(e)})},e.prototype.render=function(){var e=this;this.fill("#000000"),this.screens.forEach(function(t){t.render(),e.ctx.drawImage(t.domElement,0,0)})},e}(i),d=function(t,e){this.element=t,this.renderer=e,this.subControls=[],this.moveHandler=this.move.bind(this),this.element.on("touchstart mousedown",this.start.bind(this)),this.element.on("touchend touchcancel mouseup mouseleave",this.end.bind(this))};d.prototype.add=function(){for(var t,e=[],i=arguments.length;i--;)e[i]=arguments[i];(t=this.subControls).push.apply(t,e)},d.prototype.startDelay=function(){var t=this;this.delayed=!1,this.timer=setTimeout(function(){t.delayed=!0,t.end()},200)},d.prototype.stopDelay=function(){this.timer&&(clearTimeout(this.timer),this.timer=0)},d.prototype.call=function(e,i){void 0===i&&(i=this.point);try{this.subControls.forEach(function(t){return t[e](i)})}catch(t){alert(t.stack)}},d.prototype.click=function(){this.started&&!this.moving&&(this.call(this.delayed?"longPress":"click"),this.renderer.update(),this.renderer.render())},d.prototype.start=function(t){t.preventDefault(),this.started||(this.started=!0,t.touches&&1!==t.touches.length||(this.point=t.getPoint(),this.startDelay()),this.element.on("touchmove mousemove",this.moveHandler))},d.prototype.move=function(t){t.preventDefault();var e=t.getPoint(),i=e.x-this.point.x,s=e.y-this.point.y,n=Math.hypot(i,s);!this.moving&&3<n&&(this.moving=!0,this.stopDelay()),this.moving?(this.call("move",{point:e,lastPoint:this.point,hypot:n,deltaX:i,deltaY:s,touches:t.touches}),this.renderer.update(),this.renderer.render(),this.point=e):this.end()},d.prototype.end=function(){this.started&&(this.stopDelay(),this.click(),this.started=this.moving=this.delayed=!1,this.element.off("touchmove mousemove",this.moveHandler),this.element.off("touchend touchcancel mouseup mouseleave",this.endHandler))};var f=function(t,e){this.map=t,this.mapScreen=e,this.mapRenderer=this.mapScreen.mapRenderer};f.prototype.getPoint=function(t){var e=this.mapScreen,i=e.centerX,s=e.centerY,n=e.mapX,h=e.mapY,r=e.scale,o=i+n*r,a=s+h*r,c=this.mapRenderer.tileArea*r;return{x:Math.floor((t.x-o)/c),y:Math.floor((t.y-a)/c)}},f.prototype.click=function(t){if(this.map.finished)return this.map.reinit();var e=this.getPoint(t),i=e.x,s=e.y;this.map.started?this.map.reveal(i,s):this.map.start(i,s)},f.prototype.longPress=function(t){if(this.map.started&&!this.map.finished){var e=this.getPoint(t),i=e.x,s=e.y;this.map.mark(i,s)}},f.prototype.move=function(t){var e=t.touches,i=t.deltaX,s=t.deltaY;if(e&&2==e.length){var n=e[0].clientX-e[1].clientX,h=e[0].clientY-e[1].clientY,r=Math.hypot(n,h);this.hypot&&this.mapScreen.zoom(r<this.hypot?-.075:.075),this.hypot=r}else this.mapScreen.move(i,s)};var u=function(t,e,i,s,n){this.map=new h(t,e,i),this.mapRenderer=new a(this.map,s,n),this.mapScreen=new c(this.mapRenderer),this.renderer=new p,this.controls=new d(this.canvas,this.renderer),this.controls.add(new f(this.map,this.mapScreen)),this.renderer.add(this.mapScreen,new l(this.map))},m={canvas:{configurable:!0}};m.canvas.get=function(){return this.renderer.domElement},u.prototype.setSize=function(t,e){this.renderer.width!==t&&this.renderer.height!==e&&(this.renderer.setSize(t,e),this.renderer.update(),this.renderer.render())},Object.defineProperties(u.prototype,m);var v=new u(30,20,.25,100,5),y=document.querySelector("#game");v.setSize(window.innerWidth,window.innerHeight),window.addEventListener("resize",function(){v.setSize(window.innerWidth,window.innerHeight)}),y.appendChild(v.canvas)}();
